<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cardinality — Investment Waterfall Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script>
tailwind.config={theme:{extend:{fontFamily:{sans:["Inter","sans-serif"],mono:["JetBrains Mono","monospace"]}}}}
</script>
<style>
:root{--bg:#0F172A;--card:#1E293B;--border:#334155;--muted:#94A3B8;--emerald:#10B981;--blue:#3B82F6;--purple:#8B5CF6;--amber:#F59E0B;--red:#EF4444}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:"Inter",sans-serif;background:var(--bg);color:#E2E8F0;line-height:1.5}
.mono{font-family:"JetBrains Mono",monospace}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:24px}
.card-sm{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:16px}
.badge-g{background:#065F46;color:#34D399;padding:2px 10px;border-radius:9999px;font-size:11px;font-weight:600}
.badge-r{background:#7F1D1D;color:#FCA5A5;padding:2px 10px;border-radius:9999px;font-size:11px;font-weight:600}
input[type=range]{-webkit-appearance:none;width:100%;height:8px;border-radius:4px;background:linear-gradient(90deg,#334155,#10B981);outline:none}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:26px;height:26px;border-radius:50%;background:#10B981;cursor:pointer;box-shadow:0 0 12px rgba(16,185,129,.5)}
input[type=range]::-moz-range-thumb{width:26px;height:26px;border-radius:50%;background:#10B981;cursor:pointer;border:none}
input[type=date]{background:#1E293B;border:1px solid #334155;color:#E2E8F0;border-radius:8px;padding:6px 12px;font-family:"JetBrains Mono",monospace;font-size:14px}
input[type=date]::-webkit-calendar-picker-indicator{filter:invert(0.7)}
body.light input[type=date]{background:#fff;border-color:#E2E8F0;color:#1E293B}
body.light input[type=date]::-webkit-calendar-picker-indicator{filter:none}
table{border-collapse:collapse;width:100%}
th{text-align:left;padding:8px 12px;font-size:11px;text-transform:uppercase;letter-spacing:.05em;color:var(--muted);border-bottom:1px solid var(--border);cursor:pointer;user-select:none}
th:hover{color:var(--emerald)}
td{padding:6px 12px;font-size:13px;border-bottom:1px solid rgba(51,65,85,.3)}
.num{text-align:right;font-family:"JetBrains Mono",monospace;font-size:13px}
.kpi-val{font-family:"JetBrains Mono",monospace;font-size:28px;font-weight:700;line-height:1.2}
.kpi-lbl{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-top:4px}
.kpi-sm .kpi-val{font-size:20px}
.step{display:flex;align-items:center;gap:12px;padding:10px 14px;border-left:3px solid var(--border);margin-bottom:2px;transition:all .2s}
.step.on{border-left-color:var(--emerald);background:rgba(16,185,129,.04)}
.step.off{border-left-color:var(--red);opacity:.4}
.step-n{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0}
.nav-a{transition:color .2s}.nav-a:hover{color:var(--emerald)}
.tab-btn{padding:6px 16px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;border:1px solid transparent}
.tab-btn.active{background:var(--emerald);color:#fff;border-color:var(--emerald)}
.tab-btn:not(.active){background:transparent;color:var(--muted);border-color:var(--border)}
.tab-btn:not(.active):hover{color:#E2E8F0;border-color:var(--muted)}
body.light{background:#F8FAFC;color:#1E293B}
body.light .card,body.light .card-sm{background:#fff;border-color:#E2E8F0}
body.light th{color:#64748B;border-color:#E2E8F0}
body.light td{border-color:#F1F5F9}
body.light .kpi-lbl{color:#64748B}
body.light input[type=range]{background:linear-gradient(90deg,#E2E8F0,#10B981)}
body.light .tab-btn:not(.active){color:#64748B;border-color:#E2E8F0}
@media print{body{background:#fff!important;color:#000!important}.card,.card-sm{border:1px solid #ddd!important;background:#fff!important}nav,.slider-wrap,.no-print{display:none!important}}
@media(max-width:768px){.kpi-val{font-size:20px}}
html{scroll-behavior:smooth}
canvas{max-height:300px}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="min-h-screen">
<!-- Banner -->
<div class="bg-amber-500/10 border-b border-amber-500/30 text-center py-2 px-4 text-amber-500 text-xs font-semibold tracking-widest uppercase">
Privileged and Confidential — Preliminary Illustrative Analysis
</div>
<!-- Nav -->
<nav class="sticky top-0 z-50 bg-slate-900/95 backdrop-blur border-b border-slate-700/50 no-print">
<div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
<div class="flex items-center gap-3">
<span class="text-emerald-500 font-bold text-xl">&#9670;</span>
<span class="font-bold text-lg tracking-tight">Cardinality</span>
<span class="text-slate-500 text-sm ml-2 hidden md:inline">Investment Waterfall Analysis</span>
</div>
<div class="flex items-center gap-3 text-xs font-medium">
<a href="#summary" class="nav-a text-slate-400">Summary</a>
<a href="#cap" class="nav-a text-slate-400 hidden md:inline">Cap Table</a>
<a href="#waterfall" class="nav-a text-slate-400">Waterfall</a>
<a href="#returns" class="nav-a text-slate-400">Returns</a>
<a href="#tranches" class="nav-a text-slate-400 hidden md:inline">Tranches</a>
<a href="#ratchet" class="nav-a text-slate-400 hidden md:inline">Ratchet</a>
<a href="#ceo" class="nav-a text-slate-400">CEO</a>
<a href="#debt" class="nav-a text-slate-400 hidden md:inline">Debt</a>
<div class="relative" id="exportMenu">
<button onclick="toggleExportMenu()" class="ml-3 px-3 py-1.5 bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-semibold rounded-lg transition-all flex items-center gap-1.5" title="Export options">
<svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 3v12m0 0l-4-4m4 4l4-4M4 17v2a2 2 0 002 2h12a2 2 0 002-2v-2"/></svg>
Export &#9662;</button>
<div id="exportDropdown" class="hidden absolute right-0 top-full mt-1 w-64 bg-slate-800 border border-slate-600 rounded-lg shadow-2xl z-50 overflow-hidden">
<div class="px-3 py-2 text-xs text-slate-400 uppercase tracking-wider border-b border-slate-700 font-semibold">Full Dashboard</div>
<button onclick="exportPDF();toggleExportMenu()" class="w-full text-left px-3 py-2.5 text-sm text-slate-200 hover:bg-slate-700 flex items-center gap-2">&#128196; Download Full PDF</button>
<div class="px-3 py-2 text-xs text-slate-400 uppercase tracking-wider border-b border-t border-slate-700 font-semibold">Investor Summaries</div>
<button onclick="exportInvestorPDF('BHC');toggleExportMenu()" class="w-full text-left px-3 py-2.5 text-sm text-slate-200 hover:bg-slate-700 flex items-center gap-2">&#127963; BHC (Boathouse Capital)</button>
<button onclick="exportInvestorPDF('ACAP');toggleExportMenu()" class="w-full text-left px-3 py-2.5 text-sm text-slate-200 hover:bg-slate-700 flex items-center gap-2">&#128202; ACAP (Attain Capital)</button>
<button onclick="exportInvestorPDF('BK');toggleExportMenu()" class="w-full text-left px-3 py-2.5 text-sm text-slate-200 hover:bg-slate-700 flex items-center gap-2">&#128188; BarronKent Ventures</button>
<div class="border-t border-slate-700">
<button onclick="exportAllInvestorPDFs();toggleExportMenu()" class="w-full text-left px-3 py-2.5 text-sm text-emerald-400 hover:bg-slate-700 font-semibold flex items-center gap-2">&#11015; Download All 3</button>
</div></div></div>
<button onclick="document.body.classList.toggle('light')" class="ml-1 text-slate-400 hover:text-emerald-400 text-lg" title="Toggle theme">&#9681;</button>
</div></div></nav>
<!-- Slider + Date -->
<div class="sticky top-[53px] z-40 bg-slate-900/95 backdrop-blur border-b border-slate-700/50 slider-wrap no-print">
<div class="max-w-7xl mx-auto px-4 py-4">
<div class="flex items-center gap-6 flex-wrap">
<div class="flex-shrink-0">
<div class="text-xs text-slate-500 uppercase tracking-wider mb-1">Exit Enterprise Value</div>
<div id="evDisp" class="kpi-val text-emerald-500">$90,000,000</div>
</div>
<div class="flex-1 min-w-[200px]">
<input type="range" id="evSlider" min="0" max="35" value="4" step="1">
<div class="flex justify-between text-xs text-slate-600 mt-1"><span>$50M</span><span>$150M</span><span>$250M</span><span>$400M</span></div>
</div>
<div class="flex-shrink-0 ml-4">
<div class="text-xs text-slate-500 uppercase tracking-wider mb-1">Exit Date</div>
<input type="date" id="exitDatePicker" value="2027-12-31" min="2026-04-01" max="2035-12-31">
<div class="text-xs text-slate-500 mt-1" id="pikInfo">PIK: 1.83 yrs &middot; Factor: 1.1515x</div>
</div>
</div></div></div>
<div class="max-w-7xl mx-auto px-4 py-8 space-y-12">
<!-- S1 -->
<section id="summary">
<h2 class="text-2xl font-bold mb-1">Executive Summary</h2>
<p class="text-sm text-slate-400 mb-6">Key metrics at the selected exit enterprise value and date</p>
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
<div class="card"><div id="k_ev" class="kpi-val text-emerald-500">&mdash;</div><div class="kpi-lbl">Enterprise Value</div></div>
<div class="card"><div id="k_fd" class="kpi-val text-blue-400">&mdash;</div><div class="kpi-lbl">Fully Diluted Shares</div></div>
<div class="card"><div id="k_eq" class="kpi-val text-emerald-400">&mdash;</div><div class="kpi-lbl">Equity Available</div></div>
<div class="card"><div id="k_rps" class="kpi-val text-white">&mdash;</div><div class="kpi-lbl">Residual $ / Share</div></div>
</div>
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
<div class="card-sm kpi-sm"><div id="k_fee" class="kpi-val text-slate-300">&mdash;</div><div class="kpi-lbl">Transaction Fees (3%)</div></div>
<div class="card-sm kpi-sm"><div id="k_ceo" class="kpi-val text-slate-300">&mdash;</div><div class="kpi-lbl">CEO Phantom Equity</div></div>
<div class="card-sm kpi-sm"><div id="k_debt" class="kpi-val text-slate-300">&mdash;</div><div class="kpi-lbl">BHC Senior Debt</div></div>
<div class="card-sm kpi-sm"><div id="k_pref" class="kpi-val text-slate-300">&mdash;</div><div class="kpi-lbl">Pref Liq Pref Paid</div></div>
</div>
<div class="card"><canvas id="miniWF" height="80"></canvas></div>
</section>
<!-- S2 Cap Table -->
<section id="cap">
<div class="flex items-center justify-between mb-4 flex-wrap gap-3">
<div><h2 class="text-2xl font-bold mb-1">Capital Structure</h2>
<p class="text-sm text-slate-400">Issued &amp; Outstanding vs Fully Diluted ownership</p></div>
<div class="flex gap-2" id="capTabs">
<button class="tab-btn active" onclick="switchCapTab('current')">Current Cap Table</button>
<button class="tab-btn" onclick="switchCapTab('postconv')">Post-Conversion Cap Table</button>
</div></div>
<div id="capTabInfo" class="text-xs text-slate-500 mb-4 p-3 rounded-lg" style="background:rgba(51,65,85,.2);border:1px solid rgba(51,65,85,.3)"></div>
<div class="grid md:grid-cols-2 gap-6 mb-6">
<div class="card"><h3 id="pieIOLabel" class="text-xs font-semibold text-slate-400 mb-3 uppercase tracking-wider">Issued &amp; Outstanding</h3><canvas id="pieIO" height="220"></canvas></div>
<div class="card"><h3 id="pieFDLabel" class="text-xs font-semibold text-slate-400 mb-3 uppercase tracking-wider">Fully Diluted</h3><canvas id="pieFD" height="220"></canvas></div>
</div>
<div class="card overflow-x-auto"><table><thead><tr>
<th onclick="srt(0)">Stakeholder</th><th onclick="srt(1)">Type</th>
<th onclick="srt(2)" class="num">Common</th><th onclick="srt(3)" class="num">Pref A</th>
<th onclick="srt(4)" class="num">Pref B</th><th onclick="srt(5)" class="num">I&amp;O</th>
<th onclick="srt(6)" class="num">FD</th><th onclick="srt(7)" class="num">FD %</th>
</tr></thead><tbody id="stbody"></tbody></table></div>
</section>
<!-- S3 Waterfall -->
<section id="waterfall">
<h2 class="text-2xl font-bold mb-1">Waterfall Distribution</h2>
<p class="text-sm text-slate-400 mb-6">Priority of payments from enterprise value</p>
<div class="grid md:grid-cols-2 gap-6">
<div class="card"><h3 class="text-xs font-semibold text-slate-400 mb-3 uppercase tracking-wider">Distribution Waterfall</h3><div id="steps"></div></div>
<div class="card" style="min-height:350px"><canvas id="wfChart"></canvas></div>
</div></section>
<!-- S4 Returns -->
<section id="returns">
<h2 class="text-2xl font-bold mb-1">Investor Returns</h2>
<p class="text-sm text-slate-400 mb-6">Proceeds, MOIC, and gain/(loss) by stakeholder</p>
<div class="grid md:grid-cols-3 gap-4 mb-6" id="invCards"></div>
<div class="card mb-6 overflow-x-auto"><table><thead><tr><th>Investor</th><th class="num">Cost Basis</th><th class="num">Proceeds</th><th class="num">MOIC</th><th class="num">Gain/(Loss)</th></tr></thead><tbody id="proctbl"></tbody></table></div>
<div class="grid md:grid-cols-2 gap-6">
<div class="card" style="min-height:300px"><canvas id="moicLine"></canvas></div>
<div class="card" style="min-height:300px"><canvas id="dollarChart"></canvas></div>
</div></section>
<!-- S5 Tranches -->
<section id="tranches">
<h2 class="text-2xl font-bold mb-1">Tranche Conversion Analysis</h2>
<p class="text-sm text-slate-400 mb-6">Each preferred tranche independently tests: convert to common or take liquidation preference</p>
<div class="card mb-6 overflow-x-auto"><table><thead><tr><th>Tranche</th><th class="num">Shares</th><th class="num">Liq Pref (w/ PIK)</th><th class="num">As-Converted</th><th class="text-center">Decision</th><th class="num">Payout</th></tr></thead><tbody id="tconv"></tbody></table></div>
<div class="grid md:grid-cols-3 lg:grid-cols-4 gap-4" id="trCards"></div>
</section>
<!-- S6 Ratchet -->
<section id="ratchet">
<h2 class="text-2xl font-bold mb-1">MOIC Ratchet Warrant</h2>
<p class="text-sm text-slate-400 mb-6">BHC receives additional shares if total return &lt; 3.0x target MOIC on $10M basis</p>
<div class="grid md:grid-cols-2 gap-6">
<div class="card"><h3 class="text-xs font-semibold text-slate-400 mb-3 uppercase tracking-wider">Warrant Status</h3><div id="wInfo"></div></div>
<div class="card" style="min-height:280px"><canvas id="wChart"></canvas></div>
</div></section>
<!-- S7 CEO -->
<section id="ceo">
<h2 class="text-2xl font-bold mb-1">CEO SVPT Phantom Equity</h2>
<p class="text-sm text-slate-400 mb-6">Accelerating tiered bonus: $750K floor, 5% of EV cap</p>
<div class="grid md:grid-cols-3 gap-4 mb-6">
<div class="card"><div class="text-xs text-slate-400 mb-1">CEO Total Bonus</div><div id="ceoCta" class="mono text-xl font-bold text-emerald-400">&mdash;</div></div>
<div class="card"><div class="text-xs text-slate-400 mb-1">Structure</div><div class="text-sm text-slate-300">Tiered 1%&#8594;12% per $10M band<br>Floor: $750K &middot; Cap: 5% EV</div></div>
<div class="card" style="min-height:250px"><canvas id="ceoChart"></canvas></div>
</div>
<div class="card overflow-x-auto"><table><thead><tr><th>Exit EV</th><th class="num">CEO Bonus</th><th class="num">% of EV</th></tr></thead><tbody id="ceoTbl"></tbody></table></div>
</section>
<!-- S8 Debt -->
<section id="debt">
<h2 class="text-2xl font-bold mb-1">BHC Senior Debt</h2>
<p class="text-sm text-slate-400 mb-6">$10M principal at 14% — interest included in BHC total returns</p>
<div class="grid md:grid-cols-2 gap-6">
<div class="card"><div class="space-y-3 text-sm">
<div class="flex justify-between"><span class="text-slate-400">Principal</span><span class="mono font-semibold">$10,000,000</span></div>
<div class="flex justify-between"><span class="text-slate-400">Interest Rate</span><span class="mono">14.00%</span></div>
<div class="flex justify-between"><span class="text-slate-400">Debt Start</span><span class="mono">Apr 1, 2023</span></div>
<div class="flex justify-between"><span class="text-slate-400">Accrued Interest</span><span class="mono font-semibold" id="debtInterest">&mdash;</span></div>
<div class="flex justify-between"><span class="text-slate-400">Total Obligation</span><span class="mono font-semibold text-amber-400" id="debtTotal">&mdash;</span></div>
</div></div>
<div class="card" style="min-height:250px"><canvas id="debtChart"></canvas></div>
</div></section>
</div>
<script>
// ═══════════════════════════════════════════════════════════════
// CONFIG: All model inputs clearly labeled and grouped
// ═══════════════════════════════════════════════════════════════
const CONFIG = {
  // ── Key Dates ──
  exchangeDate: new Date(2026, 2, 1),      // 3/1/2026 Preferred Exchange Date
  debtStartDate: new Date(2023, 3, 1),     // 4/1/2023 BHC Senior Debt Start
  defaultExitDate: new Date(2027, 11, 31), // 12/31/2027 Default Exit
  noteConvDate: new Date(2026, 11, 31),    // 12/31/2026 2024 Notes Conversion

  // ── Rates & Fees ──
  pikRate: 0.08,           // 8% annual PIK on liq prefs
  debtRate: 0.14,          // 14% annual on BHC debt
  feeRate: 0.03,           // 3% transaction fees

  // ── Liquidation Preference ──
  liqPrefMultiple: 2.0,    // 2.0x OIP

  // ── BHC Senior Debt ──
  debtPrincipal: 10000000, // $10M principal

  // ── BHC MOIC Ratchet ──
  bhcBasis: 10000000,
  moicTarget: 3.0,
  maxBhcFdPct: 0.125,     // 12.5% FD cap
  bhcExistingPrefShares: 130984,

  // ── CEO SVPT ──
  ceoMinEV: 50000000,
  ceoStep: 10000000,
  ceoFloor: 750000,
  ceoCap: 0.05,
  // Accelerating tier rates (step-ups: +0.2%, +0.4%, +0.6%... not constant)
  ceoTierRates: [0.01,0.012,0.016,0.022,0.03,0.04,0.052,0.066,0.082,0.10,0.12],

  // ── Share Counts (Post-Exchange, Pre-B6) ──
  commonShares: 777334,
  esopAllocated: 0,      // Included in commonShares (777,334)
  esopOptions: 54055,    // All options (ESOP allocated 37,700 + available 16,355)
  esopAvailable: 0,      // Rolled into esopOptions above
  otherWarrants: 833,

  // ── Tranche Definitions ──
  tranches: {
    A1:{name:"Class A Series A-1 (BHC)",shares:130984,oip:26.68,inv:3494653,baseLiq:6989306,cls:"A"},
    B1:{name:"Series B-1",shares:200000,oip:15.00,inv:3000000,baseLiq:6000000,cls:"B"},
    B2:{name:"Series B-2",shares:50000,oip:20.00,inv:1000000,baseLiq:2000000,cls:"B"},
    B3:{name:"Series B-3",shares:26250,oip:40.00,inv:1050000,baseLiq:2100000,cls:"B"},
    B4:{name:"Series B-4",shares:74730,oip:40.79,inv:3048237,baseLiq:6096473,cls:"B"},
    B5:{name:"Series B-5",shares:18125,oip:68.21,inv:1236306,baseLiq:2472612,cls:"B"},
    B6:{name:"Series B-6",shares:69262,oip:37.53,inv:2599318,baseLiq:5198636,cls:"B"}
  },
  trancheKeys: ["A1","B1","B2","B3","B4","B5","B6"],
  evs: []
};
for(let e=50e6;e<=400e6;e+=10e6) CONFIG.evs.push(e);

// ═══════════════════════════════════════════════════════════════
// STAKEHOLDER HOLDINGS
// ═══════════════════════════════════════════════════════════════
// CURRENT: Post-Exchange 3/1/2026. ACAP = 0 common, 300,506 Pref B.
// Excludes B-6 (69,262) and MOIC Warrant (50,529).
const STK_CURRENT = [
  {n:"Attain Capital Partners, LLC",t:"Investor",c:0,a:0,b:300506,w:0,o:0},
  {n:"Thiag Loganathan",t:"Founder",c:200000,a:0,b:0,w:0,o:0},
  {n:"Ganesh Venkataramani",t:"Founder",c:190000,a:0,b:0,w:0,o:0},
  {n:"TGV, LLC",t:"Founder",c:147972,a:0,b:7483,w:0,o:0},
  {n:"Boathouse Capital III LP",t:"Investor",c:0,a:130984,b:0,w:0,o:0},
  {n:"BarronKent Ventures, LLC",t:"Investor",c:0,a:0,b:59866,w:0,o:0},
  {n:"Harichand Mulchand Bhatia",t:"Investor",c:49800,a:0,b:0,w:0,o:0},
  {n:"CVC LLC",t:"Investor",c:22699,a:0,b:0,w:0,o:0},
  {n:"Attain Next Gen LLC",t:"Investor",c:21571,a:0,b:0,w:0,o:0},
  {n:"Senthil Kumar",t:"Investor",c:20000,a:0,b:0,w:0,o:0},
  {n:"Ravindran Nithyanandham",t:"Employee",c:19148,a:0,b:0,w:0,o:0},
  {n:"Mukesh Makhija",t:"Investor",c:13400,a:0,b:0,w:0,o:0},
  {n:"Dhiraj Harichand Bhatia",t:"Investor",c:13000,a:0,b:0,w:0,o:0},
  {n:"Mark Davis",t:"Investor",c:10889,a:0,b:0,w:0,o:0},
  {n:"Dibyajyoti Mahanta",t:"Other",c:10069,a:0,b:0,w:0,o:0},
  {n:"Seedbux Cardinality LLC",t:"Investor",c:7502,a:0,b:0,w:0,o:0},
  {n:"Ronit Bhatia",t:"Other",c:7000,a:0,b:0,w:0,o:0},
  {n:"Mukesh G Karia",t:"Investor",c:6400,a:0,b:0,w:0,o:0},
  {n:"Mamta Amar Bhatia",t:"Investor",c:6000,a:0,b:0,w:0,o:0},
  {n:"Larish Cardi LLC",t:"Investor",c:5555,a:0,b:0,w:0,o:0},
  {n:"Kelly Family Investments LLC",t:"Investor",c:5099,a:0,b:0,w:0,o:0},
  {n:"Rocky Dayaramani",t:"Investor",c:4400,a:0,b:0,w:0,o:0},
  {n:"Cynthia L. McAtee",t:"Employee",c:4100,a:0,b:0,w:0,o:0},
  {n:"Siva Anbalagan",t:"Investor",c:2800,a:0,b:0,w:0,o:0},
  {n:"Balaji USA Business Lending, LLC",t:"Investor",c:2316,a:0,b:0,w:0,o:0},
  {n:"Chordia Investment LLC",t:"Investor",c:2316,a:0,b:0,w:0,o:0},
  {n:"Eileen A. Vinayak",t:"Investor",c:1920,a:0,b:0,w:0,o:0},
  {n:"Michael Slarve",t:"Investor",c:0,a:0,b:1250,w:0,o:0},
  {n:"A-One Investments LLC",t:"Investor",c:1158,a:0,b:0,w:0,o:0},
  {n:"Thiru Ranganathan",t:"Ex-Employee",c:0,a:0,b:0,w:833,o:0},
  {n:"Shehnaz Basha",t:"Investor",c:720,a:0,b:0,w:0,o:0},
  {n:"ESOP (available)",t:"ESOP",c:0,a:0,b:0,w:0,o:16355},
  {n:"ESOP (allocated)",t:"ESOP",c:1500,a:0,b:0,w:0,o:37700}
];
STK_CURRENT.forEach(s=>{s.io=s.c+s.a+s.b;s.fd=s.io+s.w+s.o});

// B-6 allocation (2024 Note Conv): ACAP 8658, BK 1732, TGV 8658, Levine 3463, Girish 3463, Sawant 34630, BHC 8658
const B6_MAP={"Attain Capital Partners, LLC":8658,"BarronKent Ventures, LLC":1732,
  "TGV, LLC":8658,"Boathouse Capital III LP":8658};

// POST-CONVERSION: Current + B-6 (69,262) + MOIC Warrant (50,529 to BHC)
const STK_POSTCONV = JSON.parse(JSON.stringify(STK_CURRENT));
for(const s of STK_POSTCONV){ if(B6_MAP[s.n]) s.b += B6_MAP[s.n]; if(s.n==="Boathouse Capital III LP") s.w += 50529; }
// Add new B-6 holders
STK_POSTCONV.push({n:"Sagar Sawant",t:"Investor",c:0,a:0,b:34630,w:0,o:0});
STK_POSTCONV.push({n:"Richard Levine",t:"Investor",c:0,a:0,b:3463,w:0,o:0});
STK_POSTCONV.push({n:"Girish Chandrasekhar",t:"Investor",c:0,a:0,b:3463,w:0,o:0});
STK_POSTCONV.forEach(s=>{s.io=s.c+s.a+s.b;s.fd=s.io+s.w+s.o});

const ACAP_BASIS=6500000, BHC_BASIS=10000000, BK_BASIS=2050000;

// ═══════════════════════════════════════════════════════════════
// FORMATTING
// ═══════════════════════════════════════════════════════════════
const $=v=>v<0?`(${new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0}).format(-v)})`:new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0}).format(v);
const $M=v=>`$${(v/1e6).toFixed(1)}M`;
const N=v=>new Intl.NumberFormat("en-US").format(Math.round(v));
const P=v=>(v*100).toFixed(2)+"%";
const X=v=>v.toFixed(2)+"x";

// ═══════════════════════════════════════════════════════════════
// DATE-DRIVEN RECALCULATION ENGINE
// ═══════════════════════════════════════════════════════════════

/** YEARFRAC: US NASD 30/360 (Excel basis=0) */
function yearfrac(d1, d2){
  let y1=d1.getFullYear(),m1=d1.getMonth()+1,dd1=d1.getDate();
  let y2=d2.getFullYear(),m2=d2.getMonth()+1,dd2=d2.getDate();
  const isLeap=y=>(y%4===0&&y%100!==0)||y%400===0;
  if(m1===2&&dd1===(isLeap(y1)?29:28)){dd1=30;if(m2===2&&dd2===(isLeap(y2)?29:28))dd2=30}
  if(dd1===31)dd1=30;
  if(dd1===30&&dd2===31)dd2=30;
  return((y2-y1)*360+(m2-m1)*30+(dd2-dd1))/360;
}

/** CEO SVPT tiered bonus */
function computeCEO(ev){
  if(ev<CONFIG.ceoMinEV) return 0;
  let bonus=0;
  const rates=CONFIG.ceoTierRates;
  for(let i=0;i<rates.length;i++){
    const lo=CONFIG.ceoMinEV+i*CONFIG.ceoStep;
    if(ev<=lo) break;
    bonus+=Math.min(ev,lo+CONFIG.ceoStep-0.01)-lo;
    bonus-=Math.min(ev,lo+CONFIG.ceoStep-0.01)-lo; // reset
  }
  // Redo correctly
  bonus=0;
  for(let i=0;i<rates.length;i++){
    const lo=CONFIG.ceoMinEV+i*CONFIG.ceoStep;
    const hi=lo+CONFIG.ceoStep;
    if(ev<=lo) break;
    const inTier=Math.min(ev,hi)-lo;
    bonus+=inTier*rates[i];
  }
  const lastEnd=CONFIG.ceoMinEV+rates.length*CONFIG.ceoStep;
  if(ev>lastEnd) bonus+=(ev-lastEnd)*rates[rates.length-1];
  return Math.min(bonus+CONFIG.ceoFloor,ev*CONFIG.ceoCap);
}

/** MOIC warrant shares (12.5% FD cap, uses conservative pre-warrant estimate) */
function calcWarrantShares(fdPre){
  // Always use cap-based shares: (12.5% * FD - existing pref) / (1 - 12.5%)
  const mx=Math.round((CONFIG.maxBhcFdPct*fdPre-CONFIG.bhcExistingPrefShares)/(1-CONFIG.maxBhcFdPct));
  return Math.max(0,mx);
}

/**
 * Full waterfall using the Iterative Conversion Engine logic.
 * Matches the "Iterative Conversion" tab exactly:
 *   Phase 1:  A-1 pre-warrant test (preliminary, for MOIC calc only)
 *   Phase 2:  MOIC warrant calculation (conservative MIN approach)
 *   Phase 2b: A-1 + Warrant bundled final conversion test
 *   Phase 3:  B-series sequential conversion (ascending OIP)
 *   Phase 4:  3x MOIC cap adjustment
 */
function computeWaterfall(ev, exitDate){
  const yf=yearfrac(CONFIG.exchangeDate,exitDate);
  const yfDebt=yearfrac(CONFIG.debtStartDate,exitDate);
  const pikFactor=Math.pow(1+CONFIG.pikRate,yf);
  const debt=CONFIG.debtPrincipal;
  const debtInt=debt*CONFIG.debtRate*yfDebt;

  // Build tranche data with PIK'd liq prefs
  const trD={};
  for(const k of CONFIG.trancheKeys){
    const t=CONFIG.tranches[k];
    trD[k]={...t,liqPref:t.baseLiq*pikFactor,lps:t.baseLiq*pikFactor/t.shares};
  }

  const fees=ev*CONFIG.feeRate;
  const ceo=computeCEO(ev);
  const eqAvail=ev-fees-ceo-debt;

  // Edge case: no equity
  if(eqAvail<=0){
    const r={ev,fees,ceo,debt,eqAvail:Math.max(0,eqAvail),a1Liq:0,bLiq:0,totLiq:0,resPool:0,resShares:0,rps:0,
      conv:{},trD,trPay:{},wShares:0,wPay:0,bhcEq:0,bhcTot:debt+debtInt,acapTot:0,bkTot:0,
      comPay:0,pikFactor,yf,yfDebt,debtInt,phase1Conv:false,moicCapActive:false,finalWarrant:0};
    for(const k of CONFIG.trancheKeys){r.conv[k]=false;r.trPay[k]=0}
    return r;
  }

  const baseRes=CONFIG.commonShares+CONFIG.esopAllocated+CONFIG.esopOptions+CONFIG.esopAvailable+CONFIG.otherWarrants; // 832,222
  let totalPref=0;
  for(const k of CONFIG.trancheKeys) totalPref+=CONFIG.tranches[k].shares;
  const fdPreWarrant=baseRes+totalPref; // 1,401,573

  // ═══ PHASE 1: A-1 Pre-Warrant Conversion Test ═══
  // Hypothetical: if A-1 converts, what's it worth? (ignoring warrant)
  const a1PsPhase1=eqAvail/(baseRes+CONFIG.tranches.A1.shares);
  const a1AsConvPhase1=CONFIG.tranches.A1.shares*a1PsPhase1;
  const phase1Conv=a1AsConvPhase1>trD.A1.liqPref;
  const a1PreWarrantPayout=phase1Conv?a1AsConvPhase1:Math.min(trD.A1.liqPref,eqAvail);

  // ═══ PHASE 2: MOIC Warrant Calculation ═══
  // Conservative: use MIN(pre-warrant payout, liq pref) to avoid overestimating BHC position
  const bhcPreWarrantProceeds=debt+debtInt+Math.min(a1PreWarrantPayout,trD.A1.liqPref);
  const preWarrantMOIC=bhcPreWarrantProceeds/CONFIG.bhcBasis;
  let wSh=0;
  if(preWarrantMOIC<CONFIG.moicTarget){
    // Cap-based: 12.5% ownership cap
    wSh=calcWarrantShares(fdPreWarrant);
  }

  // Warrant liq pref (no PIK — uses OIP * liqPrefMultiple only)
  const wLiqPref=wSh*CONFIG.tranches.A1.oip*CONFIG.liqPrefMultiple;

  // ═══ PHASE 2b: A-1 + Warrant Combined Final Conversion Test ═══
  const combinedShares=CONFIG.tranches.A1.shares+wSh;
  const combinedLiqPref=trD.A1.liqPref+wLiqPref;
  const fdPostWarrant=fdPreWarrant+wSh;
  const postWPs=eqAvail/fdPostWarrant;
  const a1wAsConv=combinedShares*postWPs;
  const a1wConverts=a1wAsConv>combinedLiqPref;

  // After A-1+W decision, determine equity available for B-series
  let eqForB=a1wConverts?eqAvail:eqAvail-Math.min(combinedLiqPref,eqAvail);
  let runFD=a1wConverts?baseRes+combinedShares:baseRes;

  // ═══ PHASE 3: B-Series Sequential Conversion (ascending OIP) ═══
  const bOrder=["B1","B2","B6","B3","B4","B5"]; // ascending OIP order
  let conv={};
  conv.A1=a1wConverts;
  const bPayouts={};

  for(const k of bOrder){
    const t=trD[k];
    // As-converted value = tranche's pro-rata share of remaining equity
    const asConv=t.shares/(runFD+t.shares)*eqForB;
    const converts=asConv>t.liqPref;
    conv[k]=converts;

    if(converts){
      // Converts: shares join common pool, equity unchanged
      bPayouts[k]=asConv; // will be recalculated at residual per-share
      runFD+=t.shares;
      // eqForB stays the same (converting tranches participate in residual)
    } else {
      // Takes liq pref
      const paid=Math.min(t.liqPref,eqForB);
      bPayouts[k]=paid;
      eqForB-=paid;
      // runFD stays the same
    }
  }

  // ═══ RESIDUAL CALCULATION ═══
  const resPool=eqForB; // what's left after all non-converting B liq prefs
  const resSh=runFD;    // base + all converting shares
  const rps=resSh>0?resPool/resSh:0;

  // Recalculate all payouts at residual per-share
  const trPay={};
  // A-1
  if(a1wConverts){
    trPay.A1=CONFIG.tranches.A1.shares*rps;
  } else {
    // Pro-rata split of combined liq pref: A-1 gets its share
    if(combinedLiqPref===0) trPay.A1=0;
    else trPay.A1=trD.A1.liqPref/combinedLiqPref*Math.min(combinedLiqPref,eqAvail);
  }

  // Warrant payout
  let wPay;
  if(a1wConverts){
    wPay=wSh*rps;
  } else {
    if(combinedLiqPref===0) wPay=0;
    else wPay=wLiqPref/combinedLiqPref*Math.min(combinedLiqPref,eqAvail);
  }

  // B-series payouts
  for(const k of bOrder){
    if(conv[k]){
      trPay[k]=CONFIG.tranches[k].shares*rps;
    } else {
      trPay[k]=bPayouts[k]; // already calculated as MIN(liq pref, remaining equity)
    }
  }

  const comPay=baseRes*rps;

  // ═══ PHASE 4: 3x MOIC Cap Adjustment ═══
  let prelimBhcTotal=debt+debtInt+trPay.A1+wPay;
  let prelimMOIC=prelimBhcTotal/CONFIG.bhcBasis;
  let moicCapActive=false;
  let finalWarrant=wSh;
  let excessToCommon=0;

  if(prelimMOIC>CONFIG.moicTarget){
    moicCapActive=true;
    // Target BHC equity (A-1 + W) to achieve exactly 3.0x
    const targetBhcEquity=CONFIG.moicTarget*CONFIG.bhcBasis-debt-debtInt;
    // How many warrant shares needed at current rps to reach target?
    if(rps>0){
      const adjW=Math.max(0,Math.round(targetBhcEquity/rps-CONFIG.tranches.A1.shares));
      finalWarrant=Math.min(wSh,adjW);
    } else {
      finalWarrant=0;
    }
    // Recalculate warrant payout
    const oldWPay=wPay;
    if(a1wConverts){
      wPay=finalWarrant*rps;
    } else {
      wPay=finalWarrant*CONFIG.tranches.A1.oip*CONFIG.liqPrefMultiple/combinedLiqPref*Math.min(combinedLiqPref,eqAvail);
    }
    excessToCommon=oldWPay-wPay;
  }

  const bhcEq=trPay.A1+wPay;
  const bhcTot=debt+debtInt+bhcEq;
  const finalComPay=comPay+excessToCommon;

  // ═══ INVESTOR ALLOCATIONS ═══
  const acTr={B1:200000,B2:50000,B3:25000,B4:7381,B5:18125,B6:8658};
  let acapTot=0;
  for(const [tk,sh] of Object.entries(acTr)) acapTot+=trPay[tk]*(sh/CONFIG.tranches[tk].shares);

  const bkTr={B4:59866,B6:1732};
  let bkTot=0;
  for(const [tk,sh] of Object.entries(bkTr)) bkTot+=trPay[tk]*(sh/CONFIG.tranches[tk].shares);

  // Total liq prefs for display
  const a1Liq=a1wConverts?0:trD.A1.liqPref;
  let bLiq=0;
  for(const k of bOrder){if(!conv[k]) bLiq+=trD[k].liqPref}

  return {ev,fees,ceo,debt,eqAvail,a1Liq,bLiq,totLiq:a1Liq+bLiq+wLiqPref*(a1wConverts?0:1),resPool,resShares:resSh,rps,
    conv,trD,trPay,wShares:finalWarrant,wPay,bhcEq,bhcTot,acapTot,bkTot,
    comPay:finalComPay,pikFactor,yf,yfDebt,debtInt,
    phase1Conv,moicCapActive,wLiqPref,combinedLiqPref,a1wConverts,excessToCommon};
}

function computeAllEVs(exitDate){return CONFIG.evs.map(ev=>computeWaterfall(ev,exitDate))}

// ═══════════════════════════════════════════════════════════════
// CHART REGISTRY & COLORS
// ═══════════════════════════════════════════════════════════════
let charts={};
function dc(id){if(charts[id]){charts[id].destroy();delete charts[id]}}
const CC={em:"#10B981",bl:"#3B82F6",pu:"#8B5CF6",am:"#F59E0B",rd:"#EF4444",cy:"#06B6D4",grid:"#33415533",txt:"#94A3B8"};

// ═══════════════════════════════════════════════════════════════
// CAP TABLE TABS
// ═══════════════════════════════════════════════════════════════
let capTab="current";
function switchCapTab(m){
  capTab=m;
  document.querySelectorAll("#capTabs .tab-btn").forEach(b=>b.classList.remove("active"));
  document.querySelectorAll("#capTabs .tab-btn")[m==="current"?0:1].classList.add("active");
  renderCapTable();
}
function renderCapTable(){
  const cur=capTab==="current";
  const stk=cur?STK_CURRENT:STK_POSTCONV;
  const tIO=stk.reduce((s,x)=>s+x.io,0);
  const tFD=stk.reduce((s,x)=>s+x.fd,0);
  document.getElementById("capTabInfo").innerHTML=cur
    ?"<b>Post-Exchange (3/1/2026)</b>: Excludes B-6 (69,262) and MOIC Warrant (50,529). I&amp;O: "+N(tIO)+" &middot; FD: "+N(tFD)
    :"<b>Post-Conversion</b>: Includes B-6 (69,262) + MOIC Warrant (up to 50,529 at 12.5% FD cap, subject to 3.0x MOIC cap). I&amp;O: "+N(tIO)+" &middot; FD: "+N(tFD);
  document.getElementById("pieIOLabel").textContent="Issued & Outstanding \u2014 "+N(tIO);
  document.getElementById("pieFDLabel").textContent="Fully Diluted \u2014 "+N(tFD);
  const cIO=stk.reduce((s,x)=>s+x.c,0),aIO=stk.reduce((s,x)=>s+x.a,0),bIO=stk.reduce((s,x)=>s+x.b,0);
  const wT=stk.reduce((s,x)=>s+x.w,0),oT=stk.reduce((s,x)=>s+x.o,0);
  const pc=["#10B981","#3B82F6","#8B5CF6","#F59E0B","#EF4444","#06B6D4"];
  const lo={plugins:{legend:{position:"bottom",labels:{color:"#94A3B8",padding:10,font:{size:10}}}}};
  dc("pieIO");
  charts.pieIO=new Chart(document.getElementById("pieIO"),{type:"doughnut",data:{
    labels:["Common "+(cIO/tIO*100).toFixed(1)+"%","Pref A "+(aIO/tIO*100).toFixed(1)+"%","Pref B "+(bIO/tIO*100).toFixed(1)+"%"],
    datasets:[{data:[cIO,aIO,bIO],backgroundColor:pc.slice(0,3),borderWidth:0}]},options:lo});
  dc("pieFD");
  const fdL=["Common "+(cIO/tFD*100).toFixed(1)+"%","Pref A "+(aIO/tFD*100).toFixed(1)+"%","Pref B "+(bIO/tFD*100).toFixed(1)+"%"];
  const fdD=[cIO,aIO,bIO];
  if(oT>0){fdL.push("ESOP "+(oT/tFD*100).toFixed(1)+"%");fdD.push(oT)}
  if(wT>0){fdL.push("Warrants "+(wT/tFD*100).toFixed(1)+"%");fdD.push(wT)}
  charts.pieFD=new Chart(document.getElementById("pieFD"),{type:"doughnut",data:{
    labels:fdL,datasets:[{data:fdD,backgroundColor:pc.slice(0,fdD.length),borderWidth:0}]},options:lo});
  const body=document.getElementById("stbody");
  const sorted=[...stk].sort((a,b)=>b.fd-a.fd);
  body.innerHTML=sorted.map(s=>`<tr>
    <td class="text-sm whitespace-nowrap">${s.n}</td><td class="text-xs text-slate-400">${s.t}</td>
    <td class="num mono">${s.c?N(s.c):"\u2014"}</td><td class="num mono">${s.a?N(s.a):"\u2014"}</td>
    <td class="num mono">${s.b?N(s.b):"\u2014"}</td><td class="num mono">${N(s.io)}</td>
    <td class="num mono font-medium">${N(s.fd)}</td><td class="num mono">${(s.fd/tFD*100).toFixed(2)}%</td></tr>`).join("");
}

// ═══════════════════════════════════════════════════════════════
// STATIC INIT
// ═══════════════════════════════════════════════════════════════
function initTrCards(){
  document.getElementById("trCards").innerHTML=CONFIG.trancheKeys.map(k=>{const t=CONFIG.tranches[k];return`
    <div class="card-sm"><div class="flex justify-between mb-2"><h4 class="font-semibold text-sm">${t.name}</h4><span class="text-xs text-slate-500">${k}</span></div>
    <div class="grid grid-cols-2 gap-y-1 text-xs">
      <div class="text-slate-400">Shares</div><div class="mono text-right">${N(t.shares)}</div>
      <div class="text-slate-400">OIP</div><div class="mono text-right">${$(t.oip)}</div>
      <div class="text-slate-400">Investment</div><div class="mono text-right">${$(t.inv)}</div>
      <div class="text-slate-400">Base Liq Pref</div><div class="mono text-right">${$(t.baseLiq)}</div>
      <div class="text-slate-400 col-span-2 mt-1">Liq Pref w/ PIK: <span class="mono" id="trlp-${k}">\u2014</span></div>
    </div><div class="mt-2 text-center" id="tb-${k}"></div></div>`}).join("");
}
function initCEOTable(){
  document.getElementById("ceoTbl").innerHTML=CONFIG.evs.map((ev,i)=>{
    const b=computeCEO(ev);const p=ev>0?b/ev:0;
    return`<tr ${i%2?"style=\"background:rgba(51,65,85,.15)\"":""}><td class="mono">${$M(ev)}</td><td class="num mono font-medium">${$(b)}</td><td class="num mono">${(p*100).toFixed(2)}%</td></tr>`;
  }).join("");
}

// ═══════════════════════════════════════════════════════════════
// MAIN UPDATE
// ═══════════════════════════════════════════════════════════════
const EV_STEPS=[50e6,60e6,70e6,80e6,90e6,100e6,110e6,120e6,130e6,140e6,150e6,160e6,170e6,180e6,190e6,200e6,210e6,220e6,230e6,240e6,250e6,260e6,270e6,280e6,290e6,300e6,310e6,320e6,330e6,340e6,350e6,360e6,370e6,380e6,390e6,400e6];

function getExitDate(){const v=document.getElementById("exitDatePicker").value;const[y,m,d]=v.split("-").map(Number);return new Date(y,m-1,d)}
function getEV(){return EV_STEPS[parseInt(document.getElementById("evSlider").value)]||90e6}

function update(){
  const ev=getEV(),exitDate=getExitDate();
  const w=computeWaterfall(ev,exitDate);

  document.getElementById("pikInfo").textContent="PIK: "+w.yf.toFixed(2)+" yrs \u00b7 Factor: "+w.pikFactor.toFixed(4)+"x";
  document.getElementById("evDisp").textContent=$(ev);
  document.getElementById("k_ev").textContent=$M(ev);
  document.getElementById("k_fd").textContent=N(w.resShares);
  document.getElementById("k_eq").textContent=$(w.eqAvail);
  document.getElementById("k_rps").textContent="$"+w.rps.toFixed(2);
  document.getElementById("k_fee").textContent=$(w.fees);
  document.getElementById("k_ceo").textContent=$(w.ceo);
  document.getElementById("k_debt").textContent=$(w.debt);
  document.getElementById("k_pref").textContent=$(w.totLiq);
  document.getElementById("debtInterest").textContent=$(w.debtInt);
  document.getElementById("debtTotal").textContent=$(w.debt+w.debtInt);

  // Steps
  const steps=[{l:"Transaction Fees (3%)",a:w.fees},{l:"CEO SVPT Phantom Equity",a:w.ceo},
    {l:"BHC Senior Debt (Principal)",a:w.debt},{l:"Preferred Liq Pref (A-1)",a:w.a1Liq},
    {l:"Preferred Liq Pref (B-Series)",a:w.bLiq},{l:"\u2192 Residual Pool",a:w.resPool}];
  document.getElementById("steps").innerHTML=steps.map((s,i)=>{
    const on=s.a>0?"on":"off";const bg=i<5?"rgba(239,68,68,.15)":"rgba(16,185,129,.15)";const fg=i<5?CC.rd:CC.em;
    return`<div class="step ${on}"><div class="step-n" style="background:${bg};color:${fg}">${i+1}</div>
    <div class="flex-1"><div class="text-sm">${s.l}</div><div class="mono text-xs text-slate-400">${$(s.a)}</div></div></div>`;
  }).join("");

  // Tranche table
  document.getElementById("tconv").innerHTML=CONFIG.trancheKeys.map(k=>{
    const t=w.trD[k],pay=w.trPay[k],cv=w.conv[k],ac=t.shares*w.rps;
    return`<tr><td class="text-sm font-medium">${t.name}</td><td class="num mono">${N(t.shares)}</td>
    <td class="num mono">${$(t.liqPref)}</td><td class="num mono">${$(ac)}</td>
    <td class="text-center">${cv?'<span class="badge-g">CONVERTS</span>':'<span class="badge-r">LIQ PREF</span>'}</td>
    <td class="num mono font-semibold">${$(pay)}</td></tr>`;
  }).join("");
  CONFIG.trancheKeys.forEach(k=>{
    const el=document.getElementById("tb-"+k);if(el)el.innerHTML=w.conv[k]?'<span class="badge-g">CONVERTS</span>':'<span class="badge-r">LIQ PREF</span>';
    const lp=document.getElementById("trlp-"+k);if(lp)lp.textContent=$(w.trD[k].liqPref);
  });

  // Investor proceeds
  const invs=[{n:"Boathouse Capital (BHC)",basis:BHC_BASIS,proc:w.bhcTot},
    {n:"ACAP (Attain Capital)",basis:ACAP_BASIS,proc:w.acapTot},
    {n:"BarronKent Ventures",basis:BK_BASIS,proc:w.bkTot}];
  document.getElementById("proctbl").innerHTML=invs.map(v=>{
    const m=v.proc/v.basis,g=v.proc-v.basis;
    return`<tr><td class="text-sm font-medium">${v.n}</td><td class="num mono">${$(v.basis)}</td>
    <td class="num mono font-semibold">${$(v.proc)}</td><td class="num mono">${X(m)}</td>
    <td class="num mono ${g>=0?"text-emerald-400":"text-red-400"}">${$(g)}</td></tr>`;
  }).join("");
  document.getElementById("invCards").innerHTML=invs.map((v,i)=>{
    const m=v.proc/v.basis;const colors=[CC.bl,CC.em,CC.pu];
    return`<div class="card"><div class="text-xs text-slate-400 mb-1">${v.n}</div>
    <div class="mono text-2xl font-bold" style="color:${colors[i]}">${X(m)}</div>
    <div class="mono text-sm text-slate-300">${$(v.proc)}</div>
    <div class="text-xs text-slate-500 mt-1">Basis: ${$(v.basis)}</div></div>`;
  }).join("");

  // Warrant
  const bM=w.bhcTot/BHC_BASIS;
  document.getElementById("wInfo").innerHTML=`<div class="space-y-3 text-sm">
    <div class="flex justify-between"><span class="text-slate-400">BHC MOIC</span><span class="mono font-semibold ${bM<3?"text-amber-400":"text-emerald-400"}">${X(bM)}</span></div>
    <div class="flex justify-between"><span class="text-slate-400">Target</span><span class="mono">3.00x</span></div>
    <div class="flex justify-between"><span class="text-slate-400">A-1+W Converts?</span><span class="mono font-semibold ${w.a1wConverts?"text-emerald-400":"text-amber-400"}">${w.a1wConverts?"YES":"NO"}</span></div>
    <div class="flex justify-between"><span class="text-slate-400">Warrant Shares</span><span class="mono font-semibold">${N(w.wShares)}</span></div>
    <div class="flex justify-between"><span class="text-slate-400">Warrant Proceeds</span><span class="mono">${$(w.wPay)}</span></div>
    ${w.moicCapActive?'<div class="p-2 rounded text-xs" style="background:rgba(59,130,246,.08);border:1px solid rgba(59,130,246,.2);color:#3B82F6">\u2713 3.0x MOIC cap active \u2014 warrant reduced to '+N(w.wShares)+' shares</div>':w.wShares>0?'<div class="p-2 rounded text-xs" style="background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2);color:#F59E0B">\u26a0\ufe0f Ratchet ACTIVE \u2014 '+N(w.wShares)+' shares (12.5% cap)</div>':'<div class="p-2 rounded text-xs" style="background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);color:#10B981">\u2713 No warrant needed \u2014 MOIC exceeds 3.0x naturally</div>'}
  </div>``;
  const cp=ev>0?w.ceo/ev:0;
  document.getElementById("ceoCta").textContent=`${$(w.ceo)} (${(cp*100).toFixed(2)}% of EV)`;

  updateCharts(w,exitDate);
}

// ═══════════════════════════════════════════════════════════════
// CHARTS
// ═══════════════════════════════════════════════════════════════
function updateCharts(w,exitDate){
  const all=computeAllEVs(exitDate);
  const ai=CONFIG.evs.indexOf(w.ev);
  const lbls=CONFIG.evs.map(e=>$M(e));

  // Mini waterfall
  dc("mini");
  const mL=["EV","Fees","CEO","Debt","Pref Liq","Residual"];
  const mV=[w.ev,-w.fees,-w.ceo,-w.debt,-w.totLiq,w.resPool];
  let run=0;const mB=[],mH=[],mC=[];
  mV.forEach((v,i)=>{if(i===0){mB.push(0);mH.push(v);mC.push(CC.em);run=v}
    else if(i===5){mB.push(0);mH.push(v);mC.push(CC.bl)}
    else{run+=v;mB.push(run);mH.push(-v);mC.push(CC.rd+"88")}});
  charts.mini=new Chart(document.getElementById("miniWF"),{type:"bar",data:{labels:mL,datasets:[
    {data:mB,backgroundColor:"transparent",borderWidth:0,stack:"a"},
    {data:mH,backgroundColor:mC,stack:"a",borderRadius:4}
  ]},options:{indexAxis:"y",responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},
    tooltip:{callbacks:{label:c=>$(mV[c.dataIndex])}}},
    scales:{x:{stacked:true,ticks:{color:CC.txt,callback:v=>$M(v)},grid:{color:CC.grid}},
    y:{stacked:true,ticks:{color:CC.txt,font:{size:11}},grid:{display:false}}}}});

  // Waterfall chart
  dc("wf");
  const wL=["EV","Fees","CEO","Debt","A-1 Liq","B Liq","= Residual"];
  const wV=[w.ev,-w.fees,-w.ceo,-w.debt,-w.a1Liq,-w.bLiq,w.resPool];
  run=0;const wB=[],wH=[],wC=[];
  wV.forEach((v,i)=>{if(i===0){wB.push(0);wH.push(v);wC.push(CC.em);run=v}
    else if(i===6){wB.push(0);wH.push(v);wC.push(CC.bl)}
    else{run+=v;wB.push(run);wH.push(-v);wC.push(CC.rd+"77")}});
  charts.wf=new Chart(document.getElementById("wfChart"),{type:"bar",data:{labels:wL,datasets:[
    {data:wB,backgroundColor:"transparent",borderWidth:0,stack:"a"},
    {data:wH,backgroundColor:wC,stack:"a",borderRadius:6}
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},
    title:{display:true,text:"Waterfall at "+$M(w.ev),color:CC.txt},
    tooltip:{callbacks:{label:c=>$(wV[c.dataIndex])}}},
    scales:{x:{stacked:true,ticks:{color:CC.txt},grid:{display:false}},
    y:{stacked:true,ticks:{color:CC.txt,callback:v=>$M(v)},grid:{color:CC.grid}}}}});

  // MOIC
  dc("moic");
  charts.moic=new Chart(document.getElementById("moicLine"),{type:"line",data:{labels:lbls,datasets:[
    {label:"BHC",data:all.map(r=>r.bhcTot/BHC_BASIS),borderColor:CC.bl,tension:.3,pointRadius:CONFIG.evs.map((_,i)=>i===ai?6:1.5)},
    {label:"ACAP",data:all.map(r=>r.acapTot/ACAP_BASIS),borderColor:CC.em,tension:.3,pointRadius:CONFIG.evs.map((_,i)=>i===ai?6:1.5)},
    {label:"BarronKent",data:all.map(r=>r.bkTot/BK_BASIS),borderColor:CC.pu,tension:.3,pointRadius:CONFIG.evs.map((_,i)=>i===ai?6:1.5)}
  ]},options:{responsive:true,maintainAspectRatio:false,
    plugins:{legend:{position:"top",labels:{color:CC.txt}},title:{display:true,text:"MOIC by Exit EV",color:CC.txt}},
    scales:{x:{ticks:{color:CC.txt,maxTicksLimit:8},grid:{color:CC.grid}},y:{ticks:{color:CC.txt,callback:v=>v.toFixed(1)+"x"},grid:{color:CC.grid}}}}});

  // Dollar
  dc("dollar");
  charts.dollar=new Chart(document.getElementById("dollarChart"),{type:"line",data:{labels:lbls,datasets:[
    {label:"BHC",data:all.map(r=>r.bhcTot),borderColor:CC.bl,backgroundColor:CC.bl+"22",fill:true,tension:.3},
    {label:"ACAP",data:all.map(r=>r.acapTot),borderColor:CC.em,backgroundColor:CC.em+"22",fill:true,tension:.3},
    {label:"BarronKent",data:all.map(r=>r.bkTot),borderColor:CC.pu,backgroundColor:CC.pu+"22",fill:true,tension:.3},
    {label:"Common",data:all.map(r=>r.comPay),borderColor:CC.am,backgroundColor:CC.am+"11",fill:true,tension:.3}
  ]},options:{responsive:true,maintainAspectRatio:false,
    plugins:{legend:{position:"top",labels:{color:CC.txt}},title:{display:true,text:"Dollar Returns",color:CC.txt}},
    scales:{x:{ticks:{color:CC.txt,maxTicksLimit:8},grid:{color:CC.grid}},y:{ticks:{color:CC.txt,callback:v=>$M(v)},grid:{color:CC.grid}}}}});

  // Warrant
  dc("warrant");
  charts.warrant=new Chart(document.getElementById("wChart"),{type:"bar",data:{labels:lbls,datasets:[
    {label:"Warrant Shares",data:all.map(r=>r.wShares),backgroundColor:CC.am+"66",yAxisID:"y",borderRadius:3},
    {label:"BHC MOIC",data:all.map(r=>r.bhcTot/BHC_BASIS),type:"line",borderColor:CC.bl,yAxisID:"y1",tension:.3,pointRadius:CONFIG.evs.map((_,i)=>i===ai?5:1)}
  ]},options:{responsive:true,maintainAspectRatio:false,
    plugins:{legend:{position:"top",labels:{color:CC.txt}}},
    scales:{x:{ticks:{color:CC.txt,maxTicksLimit:8},grid:{color:CC.grid}},
    y:{position:"left",ticks:{color:CC.am},grid:{color:CC.grid},title:{display:true,text:"Shares",color:CC.am}},
    y1:{position:"right",ticks:{color:CC.bl,callback:v=>v.toFixed(1)+"x"},grid:{display:false},title:{display:true,text:"MOIC",color:CC.bl}}}}});

  // CEO
  dc("ceo");
  const ceoD=CONFIG.evs.map(ev=>computeCEO(ev));
  charts.ceo=new Chart(document.getElementById("ceoChart"),{type:"bar",data:{labels:lbls,datasets:[
    {label:"CEO Bonus",data:ceoD,backgroundColor:CC.em+"66",yAxisID:"y",borderRadius:3},
    {label:"% of EV",data:CONFIG.evs.map((ev,i)=>ev>0?ceoD[i]/ev*100:0),type:"line",borderColor:CC.am,yAxisID:"y1",tension:.3,pointRadius:CONFIG.evs.map((_,i)=>i===ai?5:1)}
  ]},options:{responsive:true,maintainAspectRatio:false,
    plugins:{legend:{position:"top",labels:{color:CC.txt}}},
    scales:{x:{ticks:{color:CC.txt,maxTicksLimit:8},grid:{color:CC.grid}},
    y:{position:"left",ticks:{color:CC.em,callback:v=>$M(v)},grid:{color:CC.grid},title:{display:true,text:"Bonus",color:CC.em}},
    y1:{position:"right",min:0,max:6,ticks:{color:CC.am,callback:v=>v.toFixed(1)+"%"},grid:{display:false},title:{display:true,text:"% EV",color:CC.am}}}}});

  // Debt
  dc("debt");
  const yfd=w.yfDebt;
  charts.debt=new Chart(document.getElementById("debtChart"),{type:"bar",data:{labels:["Apr 2023","Exit"],datasets:[
    {label:"Principal",data:[10e6,10e6],backgroundColor:CC.bl+"88",stack:"a"},
    {label:"Interest",data:[0,w.debtInt],backgroundColor:CC.am+"88",stack:"a"}
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:"top",labels:{color:CC.txt}}},
    scales:{x:{ticks:{color:CC.txt},grid:{color:CC.grid}},y:{ticks:{color:CC.txt,callback:v=>$M(v)},grid:{color:CC.grid}}}}});
}

// Sorting
let sC=-1,sA=true;
function srt(col){
  if(sC===col)sA=!sA;else{sC=col;sA=true}
  const body=document.getElementById("stbody");
  const rows=Array.from(body.rows);
  rows.sort((a,b)=>{
    let av=a.cells[col].textContent.replace(/[$,%,\u2014]/g,"").trim();
    let bv=b.cells[col].textContent.replace(/[$,%,\u2014]/g,"").trim();
    const an=parseFloat(av),bn=parseFloat(bv);
    if(!isNaN(an)&&!isNaN(bn))return sA?an-bn:bn-an;
    return sA?av.localeCompare(bv):bv.localeCompare(av);
  });
  rows.forEach(r=>body.appendChild(r));
}

// ═══════════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════════
document.addEventListener("DOMContentLoaded",()=>{
  renderCapTable();initTrCards();initCEOTable();
  const sl=document.getElementById("evSlider"),dp=document.getElementById("exitDatePicker");
  let t;
  sl.addEventListener("input",()=>{clearTimeout(t);t=setTimeout(update,30)});
  dp.addEventListener("change",()=>{clearTimeout(t);t=setTimeout(()=>{initCEOTable();update()},30)});
  update();
});

// ═══════════════════════════════════════════════════════════════
// EXPORT
// ═══════════════════════════════════════════════════════════════
function toggleExportMenu(){
  const dd=document.getElementById("exportDropdown");dd.classList.toggle("hidden");
  if(!dd.classList.contains("hidden")){setTimeout(()=>{
    const cl=e=>{if(!document.getElementById("exportMenu").contains(e.target)){dd.classList.add("hidden");document.removeEventListener("click",cl)}};
    document.addEventListener("click",cl)},10)}
}
async function exportPDF(){
  const btn=document.querySelector('[onclick="exportPDF()"]');const orig=btn.innerHTML;
  btn.innerHTML="Generating...";btn.disabled=true;
  try{
    const wasL=document.body.classList.contains("light");document.body.classList.add("light");
    const hide=document.querySelectorAll("nav,.slider-wrap");hide.forEach(el=>el.style.display="none");
    const evV=document.getElementById("evDisp").textContent;
    const hdr=document.createElement("div");hdr.id="pdf-header";
    hdr.style.cssText="padding:24px 0 16px;text-align:center;border-bottom:2px solid #E2E8F0;margin-bottom:16px";
    hdr.innerHTML=`<div style="font-size:24px;font-weight:800;color:#0F172A">\u25c6 Cardinality \u2014 Waterfall Analysis</div>
      <div style="font-size:14px;color:#64748B;margin-top:4px">EV: <b style="color:#059669">${evV}</b> \u00b7 Exit: ${document.getElementById("exitDatePicker").value}</div>
      <div style="font-size:10px;color:#F59E0B;margin-top:6px;text-transform:uppercase;letter-spacing:2px">Confidential</div>`;
    const ct=document.querySelector(".max-w-7xl.mx-auto.px-4.py-8");ct.parentNode.insertBefore(hdr,ct);
    await new Promise(r=>setTimeout(r,500));
    const{jsPDF}=window.jspdf;const pdf=new jsPDF({orientation:"portrait",unit:"mm",format:"a4"});
    const W=pdf.internal.pageSize.getWidth(),H=pdf.internal.pageSize.getHeight(),mg=8,uw=W-mg*2;
    const secs=ct.querySelectorAll("section");let yP=mg;
    const hC=await html2canvas(hdr,{scale:2,useCORS:true,backgroundColor:"#FFFFFF",logging:false});
    const hR=hC.height/hC.width,hH=uw*hR;
    pdf.addImage(hC.toDataURL("image/png"),"PNG",mg,yP,uw,hH);yP+=hH+4;
    for(let i=0;i<secs.length;i++){
      const cv=await html2canvas(secs[i],{scale:2,useCORS:true,backgroundColor:"#FFFFFF",logging:false});
      const r=cv.height/cv.width,ih=uw*r;
      if(yP+ih>H-mg&&yP>mg+10){pdf.addPage();yP=mg}
      if(ih>H-mg*2){const sc=(H-mg*2)/ih;pdf.addImage(cv.toDataURL("image/png"),"PNG",mg+(uw-uw*sc)/2,yP,uw*sc,ih*sc);yP+=ih*sc+4}
      else{pdf.addImage(cv.toDataURL("image/png"),"PNG",mg,yP,uw,ih);yP+=ih+4}
    }
    const tp=pdf.internal.getNumberOfPages();
    for(let p=1;p<=tp;p++){pdf.setPage(p);pdf.setFontSize(8);pdf.setTextColor(150);pdf.text(`Page ${p}/${tp}`,W/2,H-4,{align:"center"})}
    pdf.save(`Cardinality_Waterfall_${new Date().toISOString().slice(0,10)}.pdf`);
    hdr.remove();hide.forEach(el=>el.style.display="");if(!wasL)document.body.classList.remove("light");
  }catch(e){console.error(e);alert("PDF failed")}finally{btn.innerHTML=orig;btn.disabled=false}
}

const INVESTOR_PROFILES={
  BHC:{name:"Boathouse Capital III LP",short:"BHC",color:"#3B82F6",accent:"#1E40AF",basis:BHC_BASIS,
    desc:"Senior lender + Class A preferred",
    holdings:[{type:"Senior Debt",detail:"$10M at 14%",shares:"\u2014"},{type:"A-1 Preferred",detail:"130,984 shares at $26.68",shares:"130,984"},{type:"MOIC Warrant",detail:"Up to 50,529 (12.5% cap)",shares:"\u226450,529"}],
    keyTerms:["Senior secured \u2014 first out after fees/CEO","A-1: 2.0x liq pref + 8% PIK","MOIC ratchet if < 3.0x (capped 12.5% FD)"],
    getRet:function(w){return{tot:w.bhcTot,moic:w.bhcTot/this.basis,gain:w.bhcTot-this.basis,
      comp:[{l:"Debt Principal",v:w.debt},{l:"Debt Interest (14%)",v:w.debtInt},{l:"A-1 "+(w.conv.A1?"Conv":"Liq"),v:w.trPay.A1},{l:"MOIC Warrant"+(w.moicCapActive?" (3x capped)":""),v:w.wPay}]}}},
  ACAP:{name:"Attain Capital Partners",short:"ACAP",color:"#10B981",accent:"#047857",basis:ACAP_BASIS,
    desc:"Lead B-series preferred investor",
    holdings:[{type:"B-1",detail:"200,000 @ $15",shares:"200,000"},{type:"B-2",detail:"50,000 @ $20",shares:"50,000"},
      {type:"B-3",detail:"25,000 @ $40",shares:"25,000"},{type:"B-4",detail:"7,381 @ $40.79",shares:"7,381"},
      {type:"B-5",detail:"18,125 @ $68.21",shares:"18,125"},{type:"B-6",detail:"8,658 @ $37.53",shares:"8,658"}],
    keyTerms:["0 common, 300,506 Pref B post-exchange","B-1 200K, B-2 50K, B-3 25K, B-4 7,381, B-5 18,125","B-6 8,658 added on 2024 note conversion"],
    getRet:function(w){
      const tr={B1:200000,B2:50000,B3:25000,B4:7381,B5:18125,B6:8658};
      const comp=Object.entries(tr).map(([k,sh])=>({l:k+" "+(w.conv[k]?"Conv":"Liq")+" ("+N(sh)+"/"+N(CONFIG.tranches[k].shares)+")",v:w.trPay[k]*(sh/CONFIG.tranches[k].shares)}));
      return{tot:w.acapTot,moic:w.acapTot/this.basis,gain:w.acapTot-this.basis,comp}}},
  BK:{name:"BarronKent Ventures",short:"BK",color:"#8B5CF6",accent:"#6D28D9",basis:BK_BASIS,
    desc:"B-4 and B-6 investor",
    holdings:[{type:"B-4",detail:"59,866 @ $40.79",shares:"59,866"},{type:"B-6",detail:"1,732 @ $37.53",shares:"1,732"}],
    keyTerms:["80.1% of B-4 tranche","B-6 added on 2024 note conversion"],
    getRet:function(w){
      const tr={B4:59866,B6:1732};
      const comp=Object.entries(tr).map(([k,sh])=>({l:k+" "+(w.conv[k]?"Conv":"Liq"),v:w.trPay[k]*(sh/CONFIG.tranches[k].shares)}));
      return{tot:w.bkTot,moic:w.bkTot/this.basis,gain:w.bkTot-this.basis,comp}}}
};

async function exportInvestorPDF(key){
  const inv=INVESTOR_PROFILES[key];if(!inv)return;
  const ev=getEV(),exitDate=getExitDate(),w=computeWaterfall(ev,exitDate),ret=inv.getRet(w);
  const{jsPDF}=window.jspdf;const pdf=new jsPDF({orientation:"portrait",unit:"mm",format:"a4"});
  const W=pdf.internal.pageSize.getWidth(),H=pdf.internal.pageSize.getHeight(),m=15,cw=W-m*2;
  let y=m;
  const sf=(sz,st,cl)=>{pdf.setFontSize(sz);pdf.setFont("helvetica",st||"normal");pdf.setTextColor(cl||"#1E293B")};
  const dl=(y1,cl)=>{pdf.setDrawColor(cl||"#E2E8F0");pdf.setLineWidth(0.3);pdf.line(m,y1,W-m,y1)};
  const cp=(n)=>{if(y+n>H-20){pdf.addPage();y=m}};

  pdf.setFillColor(inv.accent);pdf.rect(0,0,W,28,"F");
  sf(18,"bold","#FFFFFF");pdf.text("\u25c6 CARDINALITY \u2014 "+inv.name,m,12);
  sf(9,"normal","#FFFFFF");pdf.text(inv.desc+" \u00b7 Exit: "+$M(ev)+" \u00b7 "+document.getElementById("exitDatePicker").value,m,22);
  y=36;

  // Metrics
  const bw=(cw-9)/4;
  [{l:"PROCEEDS",v:$(ret.tot),cl:inv.accent},{l:"MOIC",v:X(ret.moic),cl:ret.moic>=3?"#059669":"#DC2626"},
   {l:"GAIN/(LOSS)",v:$(ret.gain),cl:ret.gain>=0?"#059669":"#DC2626"},{l:"BASIS",v:$(inv.basis),cl:"#475569"}
  ].forEach((mt,i)=>{
    const bx=m+i*(bw+3);pdf.setFillColor("#F8FAFC");pdf.roundedRect(bx,y,bw,18,2,2,"F");
    sf(7,"bold","#94A3B8");pdf.text(mt.l,bx+3,y+6);sf(12,"bold",mt.cl);pdf.text(mt.v,bx+3,y+14);
  });y+=26;

  // Proceeds
  sf(12,"bold");pdf.text("Proceeds Breakdown",m,y);y+=5;dl(y,inv.color);y+=4;
  ret.comp.forEach((c,i)=>{
    if(i%2===0){pdf.setFillColor("#FAFAFA");pdf.rect(m,y-2,cw,7,"F")}
    sf(9,"normal","#334155");pdf.text(c.l,m+3,y+3);
    sf(9,"bold",c.v>=0?"#059669":"#DC2626");pdf.text($(c.v),m+cw-35,y+3,{align:"right"});y+=7;
  });
  dl(y-1,"#334155");y+=2;
  pdf.setFillColor(inv.accent);pdf.rect(m,y-1,cw,8,"F");
  sf(10,"bold","#FFFFFF");pdf.text("TOTAL",m+3,y+5);pdf.text($(ret.tot),m+cw-35,y+5,{align:"right"});y+=14;

  // Sensitivity
  cp(60);sf(12,"bold");pdf.text("Sensitivity",m,y);y+=5;dl(y,inv.color);y+=4;
  pdf.setFillColor(inv.accent);pdf.rect(m,y,cw,7,"F");
  sf(8,"bold","#FFFFFF");["EV","Proceeds","MOIC","Gain"].forEach((c,i)=>pdf.text(c,[m+3,m+35,m+75,m+105][i],y+5));y+=9;
  [0,2,4,6,8,10,12,14,16,18,20,25,30,35].forEach((si,ri)=>{
    if(si>=CONFIG.evs.length)return;cp(7);
    const sw=computeWaterfall(CONFIG.evs[si],exitDate),sr=inv.getRet(sw);
    const act=CONFIG.evs[si]===ev;
    if(act){pdf.setFillColor("#DBEAFE");pdf.rect(m,y-2,cw,7,"F")}
    else if(ri%2===0){pdf.setFillColor("#FAFAFA");pdf.rect(m,y-2,cw,7,"F")}
    sf(8,act?"bold":"normal","#334155");pdf.text($M(CONFIG.evs[si]),m+3,y+3);
    sf(8,"normal",sr.gain>=0?"#059669":"#DC2626");pdf.text($(sr.tot),m+35,y+3);
    sf(8,"bold",sr.moic>=3?"#059669":"#DC2626");pdf.text(X(sr.moic),m+75,y+3);
    sf(8,"normal",sr.gain>=0?"#059669":"#DC2626");pdf.text($(sr.gain),m+105,y+3);
    y+=7;
  });

  const tp=pdf.internal.getNumberOfPages();
  for(let p=1;p<=tp;p++){pdf.setPage(p);sf(7,"normal","#94A3B8");
    pdf.text("Cardinality v1.9 \u2014 "+inv.name+" \u2014 Confidential",W/2,H-6,{align:"center"});
    pdf.text("Page "+p+"/"+tp,W-m,H-6,{align:"right"})}
  pdf.save(`Cardinality_${inv.short}_${new Date().toISOString().slice(0,10)}.pdf`);
}
async function exportAllInvestorPDFs(){for(const k of["BHC","ACAP","BK"]){await exportInvestorPDF(k);await new Promise(r=>setTimeout(r,300))}}

</script>
</body>
</html>